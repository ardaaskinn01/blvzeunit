# Iyzico Production Readiness Analysis & Migration Guide

## Executive Summary

Mevcut Iyzico entegrasyonunun kapsamlÄ± analizi sonucunda **12 kritik eksiklik** tespit edildi. Production'a geÃ§meden Ã¶nce bu eksikliklerin kapatÄ±lmasÄ± **zorunludur**. Aksi takdirde:
- âŒ Payment callback'ler baÅŸarÄ±sÄ±z olabilir (hardcoded tunnel URL'leri)
- âŒ MÃ¼ÅŸteri sipariÅŸleri kaybolabilir (transaction rollback olmadan)
- âŒ Kart bilgileri loglanabilir (gÃ¼venlik aÃ§Ä±ÄŸÄ±)
- âŒ Hata durumlarÄ±nda debugging imkansÄ±z olabilir

> [!CAUTION]
> Bu dokÃ¼mandaki tÃ¼m Ã¶nerileri uygulamadan production'a geÃ§mek **ciddi mali ve yasal riskler** iÃ§erir.

---

## 1. Kritik Eksiklikler (Production Blocker)

### ğŸ”´ GAP #1: Hardcoded Tunnel URL'leri

**Durum:** [create-payment.ts](file:///c:/Users/ardaa/my-shop/netlify/functions/create-payment.ts) ve [payment-callback.ts](file:///c:/Users/ardaa/my-shop/netlify/functions/payment-callback.ts) iÃ§inde hardcoded tunnel URL'leri var.

**Mevcut Kod:**
```typescript
// create-payment.ts line 108
callbackUrl: 'https://277e5fcc2e679e.lhr.life/.netlify/functions/payment-callback',

// payment-callback.ts line 13
const SITE_URL = 'https://277e5fcc2e679e.lhr.life';
```

**Risk:** Production'da bu URL'ler Ã§alÄ±ÅŸmayacak. Payment callback'ler baÅŸarÄ±sÄ±z olacak.

**Action Items:**
1. `callbackUrl`'i environment variable'dan al
2. `SITE_URL`'i Netlify deployment URL'den al
3. Netlify environment variables'a ekle:
   - `SITE_URL` = `https://blvzeunit.com` (production domain)
   - `PAYMENT_CALLBACK_URL` = `https://blvzeunit.com/.netlify/functions/payment-callback`

**DÃ¼zeltme:**
```typescript
// create-payment.ts
callbackUrl: process.env.PAYMENT_CALLBACK_URL || 'http://localhost:8888/.netlify/functions/payment-callback',

// payment-callback.ts
const SITE_URL = process.env.SITE_URL || 'http://localhost:8888';
```

---

### ğŸ”´ GAP #2: Transaction Atomicity EksikliÄŸi

**Durum:** [payment-callback.ts](file:///c:/Users/ardaa/my-shop/netlify/functions/payment-callback.ts) iÃ§inde Supabase update iÅŸlemleri atomic deÄŸil.

**Mevcut Kod (lines 100-136):**
```typescript
// 1. Order gÃ¼ncelle
await supabase.from('orders').update({...}).eq('id', conversationId);

// 2. Order'Ä± fetch et
await supabase.from('orders').select('*').eq('id', conversationId);

// 3. Email gÃ¶nder
await emailService.sendOrderConfirmation(orderData);
```

**Risk:** 
- EÄŸer Step 2 baÅŸarÄ±sÄ±z olursa order gÃ¼ncellendi ama email gÃ¶nderilmedi
- Partial failure durumunda data inconsistency oluÅŸur

**Action Items:**
1. Error handling ekle
2. Email gÃ¶nderme hatasÄ±nÄ± kritik hata olarak deÄŸil, warning olarak logla (mevcut âœ…)
3. Order update baÅŸarÄ±sÄ±z olursa user'a bilgi ver

**DÃ¼zeltme:**
```typescript
// payment-callback.ts iÃ§inde iyileÅŸtirme
const { error: updateError, data: updatedOrder } = await supabase
    .from('orders')
    .update({
        payment_status: 'paid',
        status: 'preparing',
        iyzico_payment_id: result.paymentId,
        updated_at: new Date().toISOString()
    })
    .eq('id', conversationId)
    .select()
    .single();

if (updateError) {
    console.error('CRITICAL: Order update failed after successful payment:', updateError);
    // Redirect to error page with retry option
    resolve({
        statusCode: 302,
        headers: {
            Location: `${SITE_URL}/payment-callback?status=warning&message=Payment successful but order update failed. Contact support with Payment ID: ${result.paymentId}`,
        },
        body: '',
    });
    return;
}

// Email gÃ¶nderme (non-blocking)
if (updatedOrder) {
    try {
        const { EmailService } = require('./services/email');
        const emailService = new EmailService();
        await emailService.sendOrderConfirmation(updatedOrder);
    } catch (emailErr) {
        console.error('Email failed (non-critical):', emailErr);
        // Continue anyway
    }
}
```

---

### ğŸ”´ GAP #3: Sensitive Data Logging

**Durum:** Payment request/response log olarak yazÄ±lÄ±yor (potansiyel kart bilgisi riski).

**Mevcut Kod:**
```typescript
// create-payment.ts line 155
console.log('Calling iyzico 3DS API with SDK');

// payment-callback.ts line 36
console.log('Iyzico Callback Body:', bodyParams);

// payment-callback.ts line 95
console.log('Iyzico 3DS Auth Response:', result);
```

**Risk:** 
- Netlify logs'da kart numarasÄ±, CVC gibi hassas bilgiler gÃ¶rÃ¼lebilir
- PCI-DSS compliance ihlali

**Action Items:**
1. Sensitive field'larÄ± mask et
2. Production'da verbose logging'i kapat
3. Sadece critical error'larÄ± logla

**DÃ¼zeltme:**
```typescript
// Yeni utility function ekle
function sanitizeForLog(obj: any) {
    const sanitized = { ...obj };
    if (sanitized.paymentCard) {
        sanitized.paymentCard = {
            ...sanitized.paymentCard,
            cardNumber: '****' + (sanitized.paymentCard.cardNumber?.slice(-4) || ''),
            cvc: '***',
        };
    }
    return sanitized;
}

// KullanÄ±m
console.log('Iyzico Request (sanitized):', sanitizeForLog(iyzicoRequest));
```

---

### ğŸ”´ GAP #4: Environment Variable Validation EksikliÄŸi

**Durum:** Environment variable'lar runtime'da kontrol ediliyor, startup'ta deÄŸil.

**Mevcut Kod:**
```typescript
// create-payment.ts line 79
if (!process.env.IYZICO_API_KEY || !process.env.IYZICO_SECRET_KEY) {
    console.error('CRITICAL: Iyzico API Keys missing!');
    return { statusCode: 500, ... };
}
```

**Risk:** Ä°lk Ã¶deme denemesinde hata ortaya Ã§Ä±kar (startup'ta fark edilmez).

**Action Items:**
1. Netlify function startup script'i ekle
2. TÃ¼m gerekli env variables'Ä± validate et
3. Missing variable'lar iÃ§in Netlify build'i fail et

**DÃ¼zeltme:**
Yeni dosya oluÅŸtur: `netlify/functions/utils/env-validator.ts`
```typescript
const REQUIRED_ENV_VARS = [
    'IYZICO_API_KEY',
    'IYZICO_SECRET_KEY',
    'IYZICO_BASE_URL',
    'VITE_SUPABASE_URL',
    'SUPABASE_SERVICE_ROLE_KEY',
    'RESEND_API_KEY',
    'SITE_URL',
    'PAYMENT_CALLBACK_URL',
];

export function validateEnvironment() {
    const missing = REQUIRED_ENV_VARS.filter(key => !process.env[key]);
    if (missing.length > 0) {
        throw new Error(`Missing required environment variables: ${missing.join(', ')}`);
    }
}

// Her function'Ä±n baÅŸÄ±nda Ã§aÄŸÄ±r
validateEnvironment();
```

---

### ğŸ”´ GAP #5: CORS Configuration

**Durum:** Wildcard CORS (`*`) kullanÄ±lÄ±yor - production'da gÃ¼venlik riski.

**Mevcut Kod:**
```typescript
// create-payment.ts line 61
const headers = {
    'Access-Control-Allow-Origin': '*',
    ...
};
```

**Risk:** Cross-site scripting saldÄ±rÄ±larÄ±, 3rd party sitelerden payment request'ler.

**Action Items:**
1. Whitelist yÃ¶ntemi kullan
2. Production domain'ini environment variable'dan al

**DÃ¼zeltme:**
```typescript
const ALLOWED_ORIGINS = process.env.NODE_ENV === 'production' 
    ? [process.env.SITE_URL]
    : ['http://localhost:8888', 'http://localhost:5173', process.env.SITE_URL];

const origin = event.headers.origin || '';
const allowedOrigin = ALLOWED_ORIGINS.includes(origin) ? origin : ALLOWED_ORIGINS[0];

const headers = {
    'Access-Control-Allow-Origin': allowedOrigin,
    'Access-Control-Allow-Credentials': 'true',
    ...
};
```

---

### ğŸŸ¡ GAP #6: Retry Mechanism EksikliÄŸi

**Durum:** Iyzico API Ã§aÄŸrÄ±larÄ±nda timeout/network error iÃ§in retry yok.

**Risk:** GeÃ§ici network hatalarÄ±nda Ã¶deme baÅŸarÄ±sÄ±z olur.

**Action Items:**
1. Exponential backoff ile retry logic ekle
2. Maximum 3 retry yap
3. Her retry'Ä± logla

---

### ğŸŸ¡ GAP #7: Database Connection Pool YÃ¶netimi

**Durum:** Her function call'da yeni Supabase client oluÅŸturuluyor.

**Risk:** High traffic'te connection pool exhaustion.

---

### ğŸŸ¡ GAP #8: Monitoring & Alerting EksikliÄŸi

**Durum:** Payment failure'lar iÃ§in monitoring/alerting yok.

**Risk:** Production'da Ã¶deme hatalarÄ± fark edilmez, revenue kaybÄ±.

**Ã–nerilen AraÃ§lar:**
- **Sentry** (Error Tracking): Free tier yeterli
- **Netlify Analytics**: Built-in, function invocation tracking
- **Custom Webhook**: Critical error'larÄ± Slack/Discord'a gÃ¶nder

---

### ğŸŸ¡ GAP #9: Rate Limiting EksikliÄŸi

**Durum:** Payment endpoint'ine rate limit yok.

**Risk:** Brute force saldÄ±rÄ±larÄ±, abuse.

---

### ğŸŸ¡ GAP #10: Idempotency Key EksikliÄŸi

**Durum:** Duplicate payment preventi yok.

**Risk:** User 2x "Pay" butonuna basarsa 2 Ã¶deme olur.

**DÃ¼zeltme:**
```sql
-- Migration: supabase/migrations/add_payment_idempotency.sql
ALTER TABLE orders ADD CONSTRAINT unique_iyzico_payment_id 
UNIQUE (iyzico_payment_id);
```

---

### ğŸŸ¡ GAP #11: Email Service Reliability

**Durum:** Email gÃ¶nderimi dynamic import ile yapÄ±lÄ±yor, queue yok.

**Action Items:**
1. Background job queue ekle
2. BaÅŸarÄ±sÄ±z email'leri retry et

---

### ğŸŸ¡ GAP #12: Test Coverage EksikliÄŸi

**Durum:** Payment flow iÃ§in automated test yok.

**Action Items:**
1. Integration test ekle (Iyzico sandbox ile)
2. CI/CD pipeline'a test ekle

---

## 2. Sandbox â†’ Production Migration Checklist

### Phase 1: Environment Preparation

#### 2.1 Iyzico Production Credentials

1. **Iyzico Dashboard'a giriÅŸ yap**  
   â†’ [https://merchant.iyzipay.com](https://merchant.iyzipay.com)

2. **Production API Key'leri al**  
   â†’ Settings â†’ API & Security â†’ Production API Keys  
   â†’ `IYZICO_API_KEY` ve `IYZICO_SECRET_KEY` kaydet

3. **Webhook URL'lerini ayarla**  
   â†’ Settings â†’ Webhooks â†’ Add Webhook  
   â†’ URL: `https://blvzeunit.com/.netlify/functions/payment-callback`  
   â†’ Events: `payment.succeeded`, `payment.failed`

4. **3DS AyarlarÄ±nÄ± kontrol et**  
   â†’ Settings â†’ 3D Secure â†’ **Mandatory 3DS** aktif olsun

#### 2.2 Netlify Environment Variables

Netlify Dashboard â†’ Site Settings â†’ Environment Variables:

```bash
# Iyzico Production
IYZICO_API_KEY=<production_key>
IYZICO_SECRET_KEY=<production_secret>
IYZICO_BASE_URL=https://api.iyzipay.com

# Site URLs
SITE_URL=https://blvzeunit.com
PAYMENT_CALLBACK_URL=https://blvzeunit.com/.netlify/functions/payment-callback

# Supabase (same as dev)
VITE_SUPABASE_URL=<your_supabase_url>
SUPABASE_SERVICE_ROLE_KEY=<service_role_key>

# Resend (same as dev)
RESEND_API_KEY=<resend_key>

# Environment
NODE_ENV=production
```

#### 2.3 Domain Configuration

1. **Netlify'da custom domain ekle**  
   â†’ Site Settings â†’ Domain Management â†’ Add Custom Domain  
   â†’ `blvzeunit.com` veya subdomain

2. **SSL Certificate**  
   â†’ Netlify otomatik Let's Encrypt saÄŸlar  
   â†’ Aktif olduÄŸundan emin ol

---

### Phase 2: Code Changes

#### 2.4 Hardcoded URL'leri Temizle

**Dosyalar:**
- [create-payment.ts](file:///c:/Users/ardaa/my-shop/netlify/functions/create-payment.ts#L108)
- [payment-callback.ts](file:///c:/Users/ardaa/my-shop/netlify/functions/payment-callback.ts#L13)

**DeÄŸiÅŸiklikler:**
```typescript
// create-payment.ts
callbackUrl: process.env.PAYMENT_CALLBACK_URL!,

// payment-callback.ts
const SITE_URL = process.env.SITE_URL!;
```

#### 2.5 Environment Validator Ekle

Yeni dosya: `netlify/functions/utils/env-validator.ts`

```typescript
const REQUIRED_ENV_VARS = [
    'IYZICO_API_KEY',
    'IYZICO_SECRET_KEY',
    'IYZICO_BASE_URL',
    'VITE_SUPABASE_URL',
    'SUPABASE_SERVICE_ROLE_KEY',
    'RESEND_API_KEY',
    'SITE_URL',
    'PAYMENT_CALLBACK_URL',
];

export function validateEnvironment() {
    const missing = REQUIRED_ENV_VARS.filter(key => !process.env[key]);
    if (missing.length > 0) {
        throw new Error(`Missing env vars: ${missing.join(', ')}`);
    }
    console.log('âœ… All required environment variables present');
}
```

---

### Phase 3: Database Migrations

#### 2.8 Payment Idempotency

```sql
-- supabase/migrations/20251222_payment_idempotency.sql
ALTER TABLE orders 
ADD CONSTRAINT unique_iyzico_payment_id 
UNIQUE NULLS NOT DISTINCT (iyzico_payment_id);

-- Index for faster lookups
CREATE INDEX idx_orders_payment_id ON orders(iyzico_payment_id) 
WHERE iyzico_payment_id IS NOT NULL;
```

Ã‡alÄ±ÅŸtÄ±r:
```bash
supabase db push
```

---

### Phase 4: Testing & Deployment

#### 2.9 Sandbox Final Test

Test senaryolarÄ±:
1. âœ… BaÅŸarÄ±lÄ± Ã¶deme (test kartÄ±: 5528790000000008)
2. âœ… BaÅŸarÄ±sÄ±z Ã¶deme (test kartÄ±: 5406670000000009)
3. âœ… 3DS authentication baÅŸarÄ±sÄ±z
4. âœ… Network timeout
5. âœ… Email gÃ¶nderimi
6. âœ… Order status update

#### 2.10 Production Deploy

```bash
git checkout main
git push origin main
```

---

## 3. Post-Deployment Verification

### 3.1 Health Check

URL: `https://blvzeunit.com/.netlify/functions/create-payment`

Test request (OPTIONS):
```bash
curl -X OPTIONS https://blvzeunit.com/.netlify/functions/create-payment
```

Beklenen response: `200 OK`

---

## 4. Monitoring & Maintenance

### 4.1 Netlify Analytics

- **Enable:** Site Settings â†’ Analytics â†’ Enable
- **Metrics:** Function invocation count, duration, error rate

### 4.2 Supabase Dashboard

- **Monitor:** Database â†’ Logs
- **Set alerts:** API usage > 80%

---

## User Review Required

> [!IMPORTANT]
> **Production Deployment Timeline:**  
> Yukardaki 12 gap'in kapatÄ±lmasÄ± tahminen **3-4 gÃ¼n** sÃ¼recektir. Acele production'a geÃ§mek yerine test edilmiÅŸ, gÃ¼venli bir sistem kurmanÄ±zÄ± Ã¶neriyorum.

> [!WARNING]
> **3rd Party Dependencies:**  
> Monitoring iÃ§in **Sentry** (free tier) kullanmayÄ± planlÄ±yorum. Alternatif istiyorsanÄ±z belirtin.

> [!CAUTION]
> **Database Migration:**  
> `unique_iyzico_payment_id` constraint eklendiÄŸinde mevcut NULL deÄŸerler var mÄ± kontrol edilmeli.

**Sorular:**
1. Monitoring tool olarak Sentry uygun mu? (Free tier)
2. Payment failure'larda Slack/Discord notification istiyor musunuz?
3. Staging environment kurulumu gerekli mi yoksa direkt production?
4. Iyzico production API key'leriniz hazÄ±r mÄ±?

OnayÄ±nÄ±z sonrasÄ± implementation'a geÃ§eceÄŸim.


## Sorun

[CheckoutPage.tsx](file:///c:/Users/ardaa/my-shop/src/pages/checkout/CheckoutPage.tsx) dosyasÄ±ndaki [handleSubmit](file:///c:/Users/ardaa/my-shop/src/pages/checkout/CheckoutPage.tsx#268-438) fonksiyonu:
1. SipariÅŸi database'e kaydediyor (status: 'pending')
2. SipariÅŸ kalemlerini kaydediyor
3. âŒ Sepeti hemen temizliyor (yanlÄ±ÅŸ - Ã¶deme baÅŸarÄ±sÄ±zsa sepet boÅŸ kalÄ±r)
4. âŒ Ana sayfaya yÃ¶nlendiriyor (yanlÄ±ÅŸ - iyzico'ya yÃ¶nlendirilmeli)

## DoÄŸru AkÄ±ÅŸ

```
KullanÄ±cÄ± â†’ SipariÅŸi Tamamla
    â†“
Database'e sipariÅŸ kaydet (status: 'pending')
    â†“
create-payment endpoint'e istek gÃ¶nder
    â†“
Ä°yzico paymentPageUrl al
    â†“
window.location.href ile iyzico'ya yÃ¶nlendir
    â†“
KullanÄ±cÄ± test kartÄ± girer
    â†“
Ä°yzico â†’ /payment-callback?token=xxx
    â†“
PaymentCallbackPage â†’ Ã–deme doÄŸrula
    â†“
Backend â†’ SipariÅŸ status'Ã¼nÃ¼ 'paid' yap
    â†“
Frontend â†’ Sepeti temizle ve baÅŸarÄ± mesajÄ± gÃ¶ster
```

## Ã–nerilen DeÄŸiÅŸiklikler

### [MODIFY] [CheckoutPage.tsx](file:///c:/Users/ardaa/my-shop/src/pages/checkout/CheckoutPage.tsx)

**DeÄŸiÅŸtirilecek bÃ¶lÃ¼m:** [handleSubmit](file:///c:/Users/ardaa/my-shop/src/pages/checkout/CheckoutPage.tsx#268-438) fonksiyonu (satÄ±r 216-297)

**YapÄ±lacak deÄŸiÅŸiklikler:**

1. SipariÅŸ kaydedildikten sonra [clearCart()](file:///c:/Users/ardaa/my-shop/src/contexts/CartContext.tsx#140-143) ve `navigate('/')` kaldÄ±rÄ±lacak
2. `create-payment` endpoint'ine istek gÃ¶nderilecek
3. Ä°yzico iÃ§in gerekli buyer ve address bilgileri hazÄ±rlanacak
4. Response'dan gelen `paymentPageUrl`'e yÃ¶nlendirilecek
5. Hata durumunda kullanÄ±cÄ±ya bilgi verilecek

**Gerekli iyzico parametreleri:**
- `orderId`: Database'den dÃ¶nen sipariÅŸ ID'si
- `basketId`: SipariÅŸ ID'si (aynÄ± deÄŸer)
- `price`: Toplam tutar
- `paidPrice`: Ã–denecek tutar (aynÄ±)
- `buyer`: KullanÄ±cÄ± bilgileri (identityNumber: dummy "11111111111", IP: "127.0.0.1")
- `shippingAddress`: Teslimat adresi
- `billingAddress`: Fatura adresi (shipping ile aynÄ±)
- `basketItems`: Sepetteki Ã¼rÃ¼nler

## Verification Plan

### Automated Tests

Mevcut test dosyasÄ± bulunamadÄ±. Manual test yapÄ±lacak.

### Manual Verification

#### Test 1: Netlify Dev ile Local Test

**HazÄ±rlÄ±k:**
```bash
npm install -g netlify-cli
netlify dev
```

**Test adÄ±mlarÄ±:**
1. `http://localhost:8888` adresini aÃ§
2. Sepete Ã¼rÃ¼n ekle
3. Checkout sayfasÄ±na git
4. Formu doldur ve sÃ¶zleÅŸmeleri kabul et
5. "SipariÅŸi Tamamla" butonuna tÄ±kla
6. **Beklenen:** Ä°yzico sandbox Ã¶deme sayfasÄ±na yÃ¶nlendirilmeli
7. Test kartÄ± gir: `5890040000000016`, SKT: `12/26`, CVV: `123`
8. 3D Secure ÅŸifre: `123456`
9. **Beklenen:** `/payment-callback?token=xxx` sayfasÄ±na yÃ¶nlendirilmeli
10. **Beklenen:** "Ã–deme BaÅŸarÄ±lÄ±!" mesajÄ± gÃ¶sterilmeli
11. **Beklenen:** Sepet temizlenmeli
12. Supabase'de sipariÅŸ kontrolÃ¼:
    ```sql
    SELECT status, payment_id FROM orders ORDER BY created_at DESC LIMIT 1;
    ```
    **Beklenen:** status = 'paid', payment_id dolu

#### Test 2: HatalÄ± Senaryo - 3D Secure HatasÄ±

1. AdÄ±m 1-6 aynÄ±
2. 3D Secure'da yanlÄ±ÅŸ ÅŸifre gir (Ã¶rn: `000000`)
3. **Beklenen:** Hata mesajÄ± gÃ¶sterilmeli
4. **Beklenen:** Database'de sipariÅŸ status 'pending' kalmalÄ±
5. **Beklenen:** Sepet korunmalÄ± (boÅŸalmamalÄ±)

#### Test 3: Ä°ptal Senaryosu

1. AdÄ±m 1-6 aynÄ±
2. Ä°yzico sayfasÄ±nda "Ä°ptal" veya "Geri" butonuna tÄ±kla
3. **Beklenen:** Hata sayfasÄ± veya checkout'a geri dÃ¶nÃ¼ÅŸ
4. **Beklenen:** Sepet korunmalÄ±

## Risk FaktÃ¶rleri

1. **Netlify Functions Local Development:** `netlify dev` kullanÄ±lmazsa functions Ã§alÄ±ÅŸmayabilir
2. **Environment Variables:** [.env.local](file:///c:/Users/ardaa/my-shop/.env.local) dosyasÄ± Netlify Dev tarafÄ±ndan otomatik yÃ¼klenmeyebilir, [netlify.toml](file:///c:/Users/ardaa/my-shop/netlify.toml) veya Netlify Dashboard'da ayarlanmalÄ±
3. **CORS:** Local test sÄ±rasÄ±nda CORS hatasÄ± alÄ±nabilir (backend'de zaten CORS headers var)

## Notlar

- Sepet **sadece** baÅŸarÄ±lÄ± Ã¶deme callback'inde temizlenecek (PaymentCallbackPage)
- Ã–deme baÅŸarÄ±sÄ±z olursa kullanÄ±cÄ± checkout'a geri dÃ¶nebilmeli
- IP adresi iyzico iÃ§in zorunlu, sandbox'ta "127.0.0.1" kullanÄ±labilir
- `identityNumber` (TC Kimlik No) iyzico iÃ§in zorunlu, sandbox'ta "11111111111" kullanÄ±labilir
